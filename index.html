<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Time Tracker</title>

  <meta name="theme-color" content="#0f172a" />
  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Time Tracker">

  <style>
    :root {
      --bg:#0f172a;--card:#1e293b;--accent:#38bdf8;--accent-dark:#0ea5e9;
      --text:#e5e7eb;--muted:#94a3b8;--danger:#ef4444;--radius:18px;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,BlinkMacSystemFont}
    body{margin:0;background:var(--bg);color:var(--text);display:flex;justify-content:center;padding:calc(14px + env(safe-area-inset-top)) 12px calc(26px + env(safe-area-inset-bottom))}
    .app{width:100%;max-width:390px}
    .topbar{display:flex;align-items:center;justify-content:center;position:relative;margin-bottom:14px}
    .topbar h1{margin:0;font-size:1.55rem}
    .gear-btn{position:absolute;right:0;top:50%;transform:translateY(-50%);width:40px;height:40px;border-radius:14px;border:none;background:#334155;color:var(--text);font-size:20px;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .gear-btn:active{transform:translateY(-50%) scale(0.98)}
    .info-btn{position:absolute;left:0;top:50%;transform:translateY(-50%);width:40px;height:40px;border-radius:14px;border:none;background:#334155;color:var(--text);font-size:20px;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .info-btn:active{transform:translateY(-50%) scale(0.98)}
    .info-text{color:var(--text);line-height:1.5}
    .info-text a{color:var(--accent);text-decoration:none}
    .card{background:var(--card);border-radius:var(--radius);padding:16px;margin-bottom:14px}
    label{font-size:.85rem;color:var(--muted);margin-bottom:6px;display:block}
    input{width:100%;padding:11px 14px;border-radius:12px;border:none;outline:none;font-size:1rem;background:#020617;color:var(--text);margin-bottom:10px}
    .row{display:flex;gap:10px}
    .btn{flex:1;padding:14px;border-radius:18px;border:none;font-size:1.05rem;font-weight:600;cursor:pointer;background:var(--accent);color:#020617}
    .btn.small-btn{padding:10px 12px;border-radius:16px;font-size:.95rem}
    .btn.stop{background:var(--danger);color:white}
    .btn:disabled{opacity:0.45;cursor:not-allowed;transform:none}
    .icon-btn{width:48px;height:48px;border-radius:50%;border:none;background:var(--accent-dark);color:#020617;font-size:22px;display:flex;align-items:center;justify-content:center;margin:10px auto 20px}
    .info p{margin:8px 0}
    .info span{color:var(--accent);font-weight:600}
    .footer-btn{width:100%;padding:12px;border-radius:16px;border:none;font-size:1rem;margin-top:8px;background:#334155;color:var(--text)}
    .status{margin:6px 0;text-align:center;font-size:.9rem;color:var(--accent)}
    .toast{position:fixed;left:50%;top:18px;transform:translateX(-50%);background:#020617cc;color:var(--text);padding:10px 14px;border-radius:14px;backdrop-filter:blur(8px);display:none;z-index:50;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .badge{display:inline-flex;align-items:center;gap:8px;background:#020617;color:var(--text);padding:8px 12px;border-radius:999px;font-size:.9rem;border:1px solid #334155}
    .switch{position:relative;display:inline-block;width:44px;height:26px}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#334155;border-radius:999px;transition:.2s}
    .slider:before{position:absolute;content:"";height:20px;width:20px;left:3px;bottom:3px;background:white;border-radius:50%;transition:.2s}
    .switch input:checked + .slider{background:var(--accent)}
    .switch input:checked + .slider:before{transform:translateX(18px)}
    .settings-section{border-top:1px solid #334155;padding-top:12px;margin-top:12px}
    /* Settings: obere Abgrenzung unter dem Titel */
    #settingsModal .settings-top-divider{
      height:1px;
      background:#334155;
      margin:10px 0 14px;
      border-radius:1px;
      opacity:.9;
    }
    .dot{width:10px;height:10px;border-radius:50%;background:var(--danger)}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:40}
    .modal{width:calc(100% - 24px);max-width:380px;max-height:calc(100vh - 80px);overflow:auto}
    .modal h3{margin:0 0 10px 0}
    #editModal .modal{
      /* etwas breiter am Handy, damit Inputs n√§her an den Rand kommen */
      width:calc(100% - 12px);
      max-width:420px;
      padding:14px 12px;
    }
    /* WICHTIG: Card-Padding im Edit-Modal √ºberschreiben (verursacht die gro√üen Seitenabst√§nde) */
    #editModal .card.modal{
      padding:12px 8px;
    }
    #editModal label{
      margin-bottom:4px;
    }
    #editModal input{
      margin-bottom:8px;
      border-radius:14px;
      /* √ºberschreibt globales input-padding nur im Edit-Modal */
      padding:11px 12px;
    }
    /* iOS Date/Time Inputs reservieren oft rechts Platz (Picker-Icon). */
    #editModal input[type="date"],
    #editModal input[type="time"]{
      -webkit-appearance:none;
      appearance:none;
      text-align:left;
      padding-left:14px;
      padding-right:10px;
    }
    /* Versuche, das Picker-Icon zu verstecken (funktioniert je nach iOS-Version unterschiedlich) */
    #editModal input[type="date"]::-webkit-calendar-picker-indicator,
    #editModal input[type="time"]::-webkit-calendar-picker-indicator{
      opacity:0;
      width:0;
      margin:0;
    }
    /* Entfernt zus√§tzlich Innenabstand, den Safari teils vergibt */
    #editModal input[type="date"]::-webkit-date-and-time-value,
    #editModal input[type="time"]::-webkit-date-and-time-value{
      text-align:left;
    }
    /* Trennlinien nur im "Eintrag √§ndern"-Popup */
    #editModal .edit-divider{
      height:1px;
      background:#334155;
      margin:10px 0 12px;
      border-radius:1px;
      opacity:.9;
    }
    /* Native Date/Time Inputs (nur f√ºr Picker) ‚Äì unsichtbar, aber per JS ausl√∂sbar */
    #editModal .native-picker{
      position:absolute;
      width:1px;
      height:1px;
      opacity:0;
      pointer-events:none;
      left:-9999px;
      top:auto;
    }
    /* Sichtbare Fake-Inputs */
    #editModal .picker-display{
      cursor:pointer;
    }
    #editModal .modal-actions{
      margin-top:10px;
    }

    @media (max-width:390px){
      #editModal .modal{width:calc(100% - 8px); padding:12px 10px}
      #editModal .card.modal{padding:10px 6px}
      #editModal input{padding:10px 12px; margin-bottom:7px}
      #editModal .modal-actions{gap:8px}
    }
    .modal-actions{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    .modal-actions .btn{flex:1;min-width:140px}
    .mini-btn{padding:8px 10px;border-radius:12px;border:1px solid #334155;background:#020617;color:var(--text);font-size:.9rem;cursor:pointer}
    .mini-btn:active{transform:scale(0.98)}
    .help-text{color:var(--muted);font-size:.85rem;margin-top:6px}
    #editModal .time-grid{
      display:flex;
      gap:10px;
      flex-direction:column;
      margin-top:6px;
    }
    #editModal .time-grid > div{
      flex:0 0 auto;
      min-width:0;
    }
    @media (min-width:420px){
      #editModal .time-grid{flex-direction:row}
      #editModal .time-grid > div{flex:1 1 160px}
    }
    .modal .row{flex-wrap:wrap}
    .modal .row > div{flex:1;min-width:140px}
    .modal input[type="time"],
    .modal input[type="date"],
    .modal input{
      min-width:0;
      max-width:100%;
    }
    .date-row{display:flex;justify-content:space-between;align-items:flex-end;gap:10px;flex-wrap:wrap}
    .date-row > div{flex:1;min-width:180px}
    .date-row .mini-btn{height:44px}
    @media (max-width:360px){
      .date-row > div{min-width:100%}
      .date-row .mini-btn{width:100%}
      .modal-actions .btn{min-width:100%}
    }
    .swipe-item{position:relative;overflow:hidden;border-bottom:1px solid #334155;background:var(--card)}
    .swipe-actions{position:absolute;top:0;right:0;bottom:0;width:88px;display:flex;align-items:center;justify-content:center;background:var(--danger)}
    .swipe-actions button{border:none;background:transparent;color:white;font-weight:700;font-size:1rem;cursor:pointer}
    .swipe-content{position:relative;z-index:1;padding:10px 0;background:var(--card);transform:translateX(0);transition:transform .15s ease}
    .swipe-item.revealed .swipe-content{transform:translateX(-88px)}
  </style>

  <!-- PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
<div class="app">
  <div class="topbar">
    <button class="info-btn" onclick="openInfo()" title="Info">‚ÑπÔ∏è</button>
    <h1>‚è±Ô∏è Time Tracker</h1>
    <button class="gear-btn" onclick="openSettings()" title="Einstellungen">‚öôÔ∏è</button>
  </div>

  <div class="card">
    <label>Projekt</label>
    <input id="project" />

    <label>Zusatz (Minuten)</label>
    <input id="extra" type="number" />

    <label>Pause (Minuten)</label>
    <input id="pause" type="number" />
  </div>

  <div class="row">
    <button id="startBtn" class="btn" onclick="startWork()">‚ñ∂ Start</button>
    <button id="stopBtn" class="btn stop" onclick="stopWork()">‚ñ† Stop</button>
  </div>

  <div id="status" class="status"></div>

  <div style="display:flex;justify-content:center;margin:6px 0 6px">
    <div id="runningBadge" class="badge" style="display:none"><span class="dot"></span>Zeit l√§uft</div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Info Popup -->
  <div id="infoModal" class="modal-backdrop" onclick="backdropCloseInfo(event)">
    <div class="card modal" onclick="event.stopPropagation()">
      <h3>Info</h3>
      <div class="info-text">
        <div>Developed by Simon Kienzl</div>
        <div>E-mail: <a href="mailto:simi.k12@gmx.at">simi.k12@gmx.at</a></div>
      </div>

      <div class="modal-actions">
        <button class="btn" onclick="closeInfo()">Schlie√üen</button>
      </div>
    </div>
  </div>


  <!-- Einstellungen Popup -->
  <div id="settingsModal" class="modal-backdrop" onclick="backdropCloseSettings(event)">
    <div class="card modal" onclick="event.stopPropagation()">
      <h3>Einstellungen</h3>
      <div class="settings-top-divider"></div>

      <div class="settings-section" style="border-top:none;padding-top:0;margin-top:0">
        <strong>√Ñnderung Zeiten</strong>

        <label>Sollzeit pro Tag (HH:MM)</label>
        <input id="targetDay" placeholder="z. B. 08:00" />

        <label>Arbeitstage/Woche</label>
        <input id="workdays" type="number" min="1" max="7" />
      </div>

      <div class="settings-section">
        <strong>Anzeige</strong>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
          <span>√úberstunden anzeigen</span>
          <label class="switch">
            <input id="toggleOvertime" type="checkbox">
            <span class="slider"></span>
          </label>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
          <span>PDF Unterschrift</span>
          <label class="switch">
            <input id="togglePdfSignature" type="checkbox">
            <span class="slider"></span>
          </label>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
          <span>PDF Summe Pause</span>
          <label class="switch">
            <input id="togglePdfPauseSum" type="checkbox">
            <span class="slider"></span>
          </label>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
          <span>PDF kompakt</span>
          <label class="switch">
            <input id="togglePdfCompact" type="checkbox">
            <span class="slider"></span>
          </label>
        </div>
      </div>

      <div class="settings-section">
        <strong style="display:block">Backup</strong>

        <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px">
          <button class="btn small-btn" onclick="runManualBackup()">üíæ Backup jetzt erstellen</button>
          <button class="btn small-btn" onclick="chooseBackupLocation()">üìÅ Backup-Speicherort festlegen</button>
          <button class="btn small-btn" onclick="importBackup()">üì• Backup importieren</button>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
          <span>Automatisches Backup</span>
          <label class="switch">
            <input id="toggleAutoBackup" type="checkbox">
            <span class="slider"></span>
          </label>
        </div>

        <div class="help-text" style="margin-top:8px">
          Letztes Auto-Backup: <span id="lastAutoBackupText">‚Äì</span><br>
          N√§chstes Auto-Backup: <span id="nextAutoBackupText">‚Äì</span>
        </div>

        <div class="help-text" style="margin-top:8px">
          Automatisches Backup t√§glich um 04:00 Uhr. Falls eine Zeit l√§uft, wird es auf den n√§chsten Tag verschoben.
        </div>
      </div>

      <div class="settings-section">
        <button class="btn" onclick="saveSettings()">Speichern</button>
        <button class="btn stop" style="margin-top:8px" onclick="closeSettings()">Schlie√üen</button>
      </div>

      <div class="settings-section">
        <button class="btn stop" onclick="clearAllData()">Alles l√∂schen</button>
        <div class="help-text" style="margin-top:8px">
          L√∂scht alle gespeicherten Eintr√§ge (Zeiten) dauerhaft von diesem Ger√§t. Kann nicht r√ºckg√§ngig gemacht werden.
        </div>
      </div>
    </div>
  </div>


  <!-- Edit Popup -->
  <div id="editModal" class="modal-backdrop" onclick="backdropCloseEdit(event)">
    <div class="card modal" onclick="event.stopPropagation()">
      <h3>Eintrag √§ndern</h3>

      <label>Projekt Nr.</label>
      <input id="editProject" />

      <label>Datum</label>
      <input id="editDateDisplay" class="picker-display" type="text" readonly />
      <input id="editDate" class="native-picker" type="date" />
      <div id="editDatePretty" class="help-text"></div>
      <div class="edit-divider"></div>

      <div class="time-grid">
        <div>
          <label>Start</label>
          <input id="editStartDisplay" class="picker-display" type="text" readonly />
          <input id="editStart" class="native-picker" type="time" />
        </div>
        <div>
          <label>Stop</label>
          <input id="editEndDisplay" class="picker-display" type="text" readonly />
          <input id="editEnd" class="native-picker" type="time" />
        </div>
      </div>
      <div class="edit-divider"></div>

      <label>Pause (Minuten)</label>
      <input id="editPause" type="number" />

      <div class="modal-actions">
        <button class="btn" onclick="saveEdit()">Speichern</button>
        <button class="btn stop" onclick="closeEdit()">Abbrechen</button>
      </div>
    </div>
  </div>

  <div class="card info">
    <p>Laufende Arbeitszeit: <span id="liveTimer">00:00</span></p>
    <p>Arbeitszeit heute: <span id="workToday">00:00</span></p>
    <p>Pause heute: <span id="pauseToday">00:00</span></p>
    <p>Wochenbilanz: <span id="weekBalance">00:00</span></p>
    <p>√úberstunden heute: <span id="otToday">+00:00</span></p>
    <p>√úberstunden Woche: <span id="otWeek">+00:00</span></p>
    <p>√úberstunden Monat: <span id="otMonth">+00:00</span></p>
  </div>

  <button id="monthToggleBtn" class="footer-btn" onclick="toggleMonth()">Monats√ºbersicht</button>

  <div id="monthView" class="card" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <strong id="monthTitle">Monats√ºbersicht</strong>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="icon-btn" style="width:38px;height:38px;margin:0" onclick="prevMonth()" title="Vorheriger Monat">‚Äπ</button>
        <select id="monthSelect" style="background:#020617;color:var(--text);border:1px solid #334155;border-radius:12px;padding:8px 10px">
          <option value="01">Januar</option><option value="02">Februar</option><option value="03">M√§rz</option><option value="04">April</option>
          <option value="05">Mai</option><option value="06">Juni</option><option value="07">Juli</option><option value="08">August</option>
          <option value="09">September</option><option value="10">Oktober</option><option value="11">November</option><option value="12">Dezember</option>
        </select>
        <select id="yearSelect" style="background:#020617;color:var(--text);border:1px solid #334155;border-radius:12px;padding:8px 10px"></select>
        <button class="icon-btn" style="width:38px;height:38px;margin:0" onclick="nextMonth()" title="N√§chster Monat">‚Ä∫</button>
      </div>
    </div>

    <div id="monthContent" style="margin:10px 0"></div>
    <button class="btn small-btn" style="margin-top:10px" onclick="exportMonthPdf()">üìÑ PDF Export (Monat)</button>
  </div>
</div>

<script>
const LS=k=>JSON.parse(localStorage.getItem(k));
const SS=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
// --- Swipe-to-delete helpers for Monats√ºbersicht ---
function closeAllSwipes(exceptEl=null){
  document.querySelectorAll('.swipe-item.revealed').forEach(el=>{
    if(exceptEl && el === exceptEl) return;
    el.classList.remove('revealed');
  });
}
function deleteEntryAtIndex(idx){
  const entries = LS('entries') || [];
  if(idx < 0 || idx >= entries.length){
    showToast('‚ö†Ô∏è Eintrag nicht gefunden');
    return;
  }
  if(!confirm('Diesen Eintrag wirklich l√∂schen?')) return;

  entries.splice(idx, 1);
  SS('entries', entries);
  showToast('üóëÔ∏è Eintrag gel√∂scht');
  setStatus('üóëÔ∏è Eintrag gel√∂scht');

  // UI aktualisieren
  renderSelectedMonth();
  updateInfo();
}

function attachSwipeHandlers(itemEl){
  let startX = 0;
  let startY = 0;
  let moved = false;

  const onStart = (x,y) => { startX = x; startY = y; moved = false; };

  const onMove = (x,y) => {
    const dx = x - startX;
    const dy = y - startY;

    // nur horizontal, sonst scrollen
    if(Math.abs(dx) > 10 && Math.abs(dx) > Math.abs(dy)) moved = true;
  };

  const onEnd = (x) => {
    if(!moved) return;
    const dx = x - startX;
    // swipe left to reveal (and close others)
    if(dx < -40){
      closeAllSwipes(itemEl);
      itemEl.classList.add('revealed');
    }
    // swipe right to close
    if(dx > 40) itemEl.classList.remove('revealed');
  };

  itemEl.addEventListener('touchstart', (e)=> {
    const t = e.touches[0];
    onStart(t.clientX, t.clientY);
  }, {passive:true});

  itemEl.addEventListener('touchmove', (e)=> {
    const t = e.touches[0];
    onMove(t.clientX, t.clientY);
  }, {passive:true});

  itemEl.addEventListener('touchend', (e)=> {
    const t = e.changedTouches[0];
    onEnd(t.clientX);
  });

  // Optional: mouse support (desktop)
  let mouseDown = false;
  itemEl.addEventListener('mousedown', (e)=>{ mouseDown=true; onStart(e.clientX, e.clientY); });
  itemEl.addEventListener('mousemove', (e)=>{ if(mouseDown) onMove(e.clientX, e.clientY); });
  itemEl.addEventListener('mouseup', (e)=>{ if(!mouseDown) return; mouseDown=false; onEnd(e.clientX); });
  itemEl.addEventListener('mouseleave', ()=>{ mouseDown=false; });
}

// Close revealed swipe rows when tapping outside a row
document.addEventListener('touchstart', (e)=>{
  if(monthView && monthView.style.display === 'block'){
    if(!e.target.closest('.swipe-item')) closeAllSwipes();
  }
}, {passive:true});

document.addEventListener('click', (e)=>{
  if(monthView && monthView.style.display === 'block'){
    if(!e.target.closest('.swipe-item')) closeAllSwipes();
  }
});


project.value=LS('project')||'';
pause.value=LS('pause')??30;

// Sollzeit/√úberstunden Einstellungen
targetDay.value=LS('targetDay') || '08:00';
workdays.value=LS('workdays') ?? 5;
toggleOvertime.checked = LS('showOvertime') !== false;
togglePdfSignature.checked = LS('pdfSignature') !== false;
togglePdfPauseSum.checked = LS('pdfPauseSum') !== false;
togglePdfCompact.checked = LS('pdfCompact') === true;
toggleAutoBackup.checked = LS('autoBackupEnabled') !== false;

project.onchange=e=>SS('project',e.target.value);
pause.onchange=e=>SS('pause',Number(e.target.value));
targetDay.onchange=e=>SS('targetDay', String(e.target.value || '08:00'));
workdays.onchange=e=>SS('workdays', Number(e.target.value || 5));
// Auto-backup toggle: update preview text instantly (saved on "Speichern")
if(typeof toggleAutoBackup !== 'undefined' && toggleAutoBackup){
  toggleAutoBackup.onchange = ()=>{ try{ updateBackupStatusUI(); }catch(_){ } };
}

let liveInterval=null;

function setStatus(msg){status.textContent=msg;setTimeout(()=>status.textContent='',2000)}
function showToast(msg){
  toast.textContent = msg;
  toast.style.display = 'block';
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=> toast.style.display='none', 2000);
}
function setRunning(isRunning){
  runningBadge.style.display = isRunning ? 'inline-flex' : 'none';
  if (startBtn) startBtn.disabled = !!isRunning; // Start nur wenn NICHT l√§uft
  if (stopBtn) stopBtn.disabled = !isRunning;    // Stop nur wenn L√ÑUFT
}

function startLiveTimer(start){
  clearInterval(liveInterval);
  const tick=()=>liveTimer.textContent=fmt(Math.floor((Date.now()-start)/60000));
  tick();
  liveInterval=setInterval(tick,60000);
}
function stopLiveTimer(){clearInterval(liveInterval);liveTimer.textContent='00:00'}

function startWork(){
    const already = LS('running');
  if(already){
    showToast('‚ÑπÔ∏è Zeit l√§uft bereits');
    setStatus('‚ÑπÔ∏è Zeit l√§uft bereits');
    setRunning(true);
    return;
  }
  const start=Date.now();
  SS('running',{start});
  startLiveTimer(start);
  setRunning(true);
  showToast('‚úÖ Gestartet');
  setStatus('‚è±Ô∏è Arbeitszeit l√§uft‚Ä¶');
}

function stopWork(){
  const run=LS('running');
  if(!run){
    showToast('‚ö†Ô∏è Keine laufende Zeit');
    setStatus('‚ö†Ô∏è Keine laufende Zeit');
    return;
  }
  stopLiveTimer();
  setRunning(false);

  const startMs = run.start;
  const endMs = Date.now();
  const startHM = fmtHMFromMs(startMs);
  const endHM = fmtHMFromMs(endMs);

  const pauseMin = Number(pause.value||0);
  const extraMin = Number(extra.value||0);

  const minutes = calcWorkMinutesFromStartEnd(startHM, endHM, pauseMin, extraMin);

  const entry={
    date:new Date().toISOString().slice(0,10),
    project:project.value,
    startHM,
    endHM,
    startMs,
    endMs,
    minutes,
    pause: pauseMin,
    extraMin
  };

  const entries=LS('entries')||[];
  entries.push(entry);
  SS('entries',entries);

  localStorage.removeItem('running');
  extra.value='';
  updateInfo();
  showToast('‚úÖ Gespeichert');
  setStatus('‚úÖ Zeit gespeichert');
}


function closeEdit(){ editModal.style.display = 'none'; }
function backdropCloseEdit(e){ if(e.target === editModal) closeEdit(); }

function syncEditDatePretty(){
  const v = String(editDate.value || '').trim();
  // sichtbares Feld (dd.mm.yyyy)
  if(typeof editDateDisplay !== 'undefined' && editDateDisplay){
    editDateDisplay.value = v ? v.split('-').reverse().join('.') : '';
  }
  editDatePretty.textContent = v ? `Anzeige: ${fmtDate(v)}` : '';
}

function syncEditTimeDisplays(){
  const s = normTimeStr(editStart.value);
  const e = normTimeStr(editEnd.value);
  if(typeof editStartDisplay !== 'undefined' && editStartDisplay){
    editStartDisplay.value = s || '';
  }
  if(typeof editEndDisplay !== 'undefined' && editEndDisplay){
    editEndDisplay.value = e || '';
  }
}

function openNativePicker(el){
  if(!el) return;
  try{
    if(typeof el.showPicker === 'function') el.showPicker();
    else { el.focus(); el.click(); }
  }catch(_){
    try{ el.focus(); el.click(); }catch(__){}
  }
}

function openSettings(){
  // ensure inputs show current persisted values
  targetDay.value = LS('targetDay') || targetDay.value || '08:00';
  workdays.value = LS('workdays') ?? workdays.value ?? 5;

  toggleOvertime.checked = LS('showOvertime') !== false;
  togglePdfSignature.checked = LS('pdfSignature') !== false;
  togglePdfPauseSum.checked = LS('pdfPauseSum') !== false;
  togglePdfCompact.checked = LS('pdfCompact') === true;
  toggleAutoBackup.checked = LS('autoBackupEnabled') !== false;

  try{ updateBackupStatusUI(); }catch(_){ }
  settingsModal.style.display = 'flex';
}
function closeSettings(){
  settingsModal.style.display = 'none';
}
function backdropCloseSettings(e){
  if(e.target === settingsModal) closeSettings();
}
function saveSettings(){
  // persist + refresh UI
  SS('targetDay', String(targetDay.value || '08:00'));
  SS('workdays', Number(workdays.value || 5));
  SS('showOvertime', toggleOvertime.checked);
  applyOvertimeVisibility();
  SS('pdfSignature', togglePdfSignature.checked);
  SS('pdfPauseSum', togglePdfPauseSum.checked);
  SS('pdfCompact', togglePdfCompact.checked);
  SS('autoBackupEnabled', toggleAutoBackup.checked);
  try{ updateBackupStatusUI(); }catch(_){ }
  showToast('‚úÖ Einstellungen gespeichert');
  setStatus('‚úÖ Einstellungen gespeichert');
  updateInfo();
  closeSettings();
}
function applyOvertimeVisibility(){
  const show = LS('showOvertime') !== false;
  ['otToday','otWeek','otMonth'].forEach(id=>{
    const el = document.getElementById(id);
    if(el && el.parentElement){
      el.parentElement.style.display = show ? '' : 'none';
    }
  });
}

function openInfo(){
  infoModal.style.display = 'flex';
}
function closeInfo(){
  infoModal.style.display = 'none';
}
function backdropCloseInfo(e){
  if(e.target === infoModal) closeInfo();
}

function saveEdit(){
  const entries = LS('entries') || [];
  if(!entries.length) return;

  const idx = Number(editModal.dataset.idx ?? (entries.length - 1));
  const prev = entries[idx] || {};
  const oldYM = String(prev.date || '').slice(0,7);

  const startHM = normTimeStr(editStart.value);
  const endHM = normTimeStr(editEnd.value);
  const pauseMin = Number(editPause.value || 0);
  const extraMin = Number(prev.extraMin || 0);

  const newDate = String(
    editDate.value ||
    prev.date ||
    new Date().toISOString().slice(0,10)
  );
  const newYM = String(newDate || '').slice(0,7);

  entries[idx] = {
    ...prev,
    date: newDate,
    project: String(editProject.value || ''),
    startHM,
    endHM,
    pause: pauseMin,
    extraMin,
    minutes: calcWorkMinutesFromStartEnd(startHM, endHM, pauseMin, extraMin),
  };

  SS('entries', entries);
  // Hinweis, wenn Eintrag in anderen Monat verschoben wurde
  if(oldYM && newYM && oldYM !== newYM){
    showToast('‚ÑπÔ∏è Eintrag in anderen Monat verschoben');
    setStatus('‚ÑπÔ∏è Eintrag in anderen Monat verschoben');
  }
  // falls Monats√ºbersicht offen ist: Liste neu rendern
  if(monthView && monthView.style.display === 'block'){
    renderSelectedMonth();
  }
  closeEdit();
  updateInfo();
  showToast('‚úÖ Eintrag ge√§ndert');
  setStatus('‚úÖ Eintrag aktualisiert');
}

function openMonth(){
  monthToggleBtn.textContent='Monats√ºbersicht schlie√üen';
  monthView.style.display='block';

  const now = new Date();
  if(!monthSelect.value) monthSelect.value = String(now.getMonth()+1).padStart(2,'0');
  if(!yearSelect.value) yearSelect.value = String(now.getFullYear());

  renderSelectedMonth();
}

function toggleMonth(){
  const isOpen = monthView.style.display === 'block';
  if(isOpen) closeMonth(); else openMonth();
}
function closeMonth(){
  monthView.style.display='none';
  monthToggleBtn.textContent='Monats√ºbersicht';
}

function clearAllData(){
  if(!confirm(
    'Willst du wirklich ALLE gespeicherten Zeiten l√∂schen?\n\n' +
    'Dieser Vorgang kann nicht r√ºckg√§ngig gemacht werden.'
  )) return;

  localStorage.removeItem('entries');

  updateInfo();

  if(monthView && monthView.style.display === 'block'){
    renderSelectedMonth();
  }

  showToast('üóëÔ∏è Alle Daten gel√∂scht');
  setStatus('üóëÔ∏è Alle Daten gel√∂scht');
}

function fmt(m){
  const mm = Math.max(0, Number(m||0));
  return String(Math.floor(mm/60)).padStart(2,'0')+':'+String(mm%60).padStart(2,'0');
}

function fmtSigned(min){
  const n = Number(min||0);
  const sign = n >= 0 ? '+' : '-';
  return sign + fmt(Math.abs(n));
}

function fmtHMFromMs(ms){
  const d = new Date(ms);
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  return `${hh}:${mm}`;
}

function normTimeStr(t){
  const s = String(t||'').trim();
  if(!s) return '';
  const parts = s.split(':');
  if(parts.length >= 2){
    const hh = String(parts[0]).padStart(2,'0');
    const mm = String(parts[1]).padStart(2,'0');
    return `${hh}:${mm}`;
  }
  return '';
}

function parseTimeToMinutes(val){
  const s = String(val || '').trim();
  if(!s) return 0;
  if(s.includes(':')){
    const [hh, mm] = s.split(':');
    const h = Number(hh);
    const m = Number(mm);
    if(Number.isFinite(h) && Number.isFinite(m)) return Math.max(0, h*60 + m);
    return 0;
  }
  const n = Number(s);
  return Number.isFinite(n) ? Math.max(0, n) : 0;
}

function calcWorkMinutesFromStartEnd(startStr, endStr, pauseMin, extraMin){
  const sMin = parseTimeToMinutes(startStr);
  const eMin0 = parseTimeToMinutes(endStr);
  if(!Number.isFinite(sMin) || !Number.isFinite(eMin0)) return 0;

  // Mitternacht erlaubt
  let eMin = eMin0;
  if(eMin < sMin) eMin += 24*60;

  const diff = Math.max(0, eMin - sMin);
  const total = diff - Number(pauseMin||0) + Number(extraMin||0);
  return Math.max(0, total);
}

function openEditAtIndex(idx){
  const entries = LS('entries') || [];
  if(idx < 0 || idx >= entries.length){
    showToast('‚ö†Ô∏è Eintrag nicht gefunden');
    return;
  }
  editModal.dataset.idx = String(idx);

  const e = entries[idx];
  editProject.value = e.project || '';
  editDate.value = e.date || '';
  syncEditDatePretty();
  editStart.value = normTimeStr(e.startHM) || '';
  editEnd.value = normTimeStr(e.endHM) || '';
  syncEditTimeDisplays();
  editPause.value = Number(e.pause ?? 0);

  editModal.style.display = 'flex';
}

function fmtDate(dateStr){
  if(!dateStr) return '';
  const [y,m,d] = dateStr.split('-');
  return `${d}-${m}-${y.slice(2)}`;
}

function monthName(idx){
  const names = ['Januar','Februar','M√§rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
  return names[idx] || '';
}

function initMonthSelectors(){
  const now = new Date();
  monthSelect.value = String(now.getMonth()+1).padStart(2,'0');

  const y = now.getFullYear();
  yearSelect.innerHTML = '';
  for(let yy = y - 5; yy <= y + 1; yy++){
    const opt = document.createElement('option');
    opt.value = String(yy);
    opt.textContent = String(yy);
    yearSelect.appendChild(opt);
  }
  yearSelect.value = String(y);

  monthSelect.onchange = () => renderSelectedMonth();
  yearSelect.onchange = () => renderSelectedMonth();
}

function selectedYM(){
  const y = String(yearSelect.value || new Date().getFullYear());
  const m = String(monthSelect.value || String(new Date().getMonth()+1).padStart(2,'0'));
  return `${y}-${m}`;
}

function renderSelectedMonth(){
  monthContent.innerHTML = '';

  const ym = selectedYM();
  const y = ym.slice(0,4);
  const m = ym.slice(5,7);

  monthTitle.textContent = `Monats√ºbersicht ‚Äì ${monthName(Number(m)-1)} ${y}`;

  const all = (LS('entries')||[]);
  const rows = all.map((e,idx)=>({e,idx})).filter(x => String(x.e.date||'').startsWith(ym));

  if(!rows.length){
    const empty=document.createElement('div');
    empty.style.color='#94a3b8';
    empty.style.padding='10px 0';
    empty.textContent='Keine Eintr√§ge in diesem Monat.';
    monthContent.appendChild(empty);
    return;
  }

  rows.forEach(({e,idx})=>{
    const item = document.createElement('div');
    item.className = 'swipe-item';

    const actions = document.createElement('div');
    actions.className = 'swipe-actions';
    const delBtn = document.createElement('button');
    delBtn.type = 'button';
    delBtn.textContent = 'L√∂schen';
    delBtn.onclick = (ev)=>{ ev.stopPropagation(); deleteEntryAtIndex(idx); };
    actions.appendChild(delBtn);

    const content = document.createElement('div');
    content.className = 'swipe-content';
    content.style.cursor = 'pointer';
    content.innerHTML = `<strong>${fmtDate(e.date)}</strong><br>Projekt: ${e.project||'-'}<br>Start: ${e.startHM||'--:--'} ¬∑ Stop: ${e.endHM||'--:--'}<br>Arbeitszeit: ${fmt(e.minutes)} ¬∑ Pause: ${fmt(e.pause||0)}<div style=\"color:#94a3b8;font-size:.85rem;margin-top:4px\">Tippen zum Bearbeiten ¬∑ nach links wischen zum L√∂schen</div>`;
    content.onclick = ()=>{
      closeAllSwipes();
      openEditAtIndex(idx);
    };

    item.appendChild(actions);
    item.appendChild(content);
    attachSwipeHandlers(item);

    monthContent.appendChild(item);
  });
}

function prevMonth(){
  let y = Number(yearSelect.value || new Date().getFullYear());
  let m = Number(monthSelect.value || (new Date().getMonth()+1));
  m -= 1;
  if(m <= 0){ m = 12; y -= 1; }
  monthSelect.value = String(m).padStart(2,'0');
  yearSelect.value = String(y);
  renderSelectedMonth();
}

function nextMonth(){
  let y = Number(yearSelect.value || new Date().getFullYear());
  let m = Number(monthSelect.value || (new Date().getMonth()+1));
  m += 1;
  if(m >= 13){ m = 1; y += 1; }
  monthSelect.value = String(m).padStart(2,'0');
  yearSelect.value = String(y);
  renderSelectedMonth();
}

function exportMonthPdf(){
  const jsPDF = (window.jspdf && window.jspdf.jsPDF) ? window.jspdf.jsPDF : null;
  if(!jsPDF){
    showToast('‚ö†Ô∏è PDF-Library nicht geladen');
    return;
  }

  const ym = selectedYM();
  const y = ym.slice(0,4);
  const m = ym.slice(5,7);

  const all = (LS('entries')||[]);
  const monthEntries = all
    .filter(e => String(e.date||'').startsWith(ym))
    .map(e => ({
      date: e.date,
      dateDisp: fmtDate(e.date),
      project: e.project || '-',
      startHM: e.startHM || '',
      endHM: e.endHM || '',
      work: fmt(Number(e.minutes||0)),
      pause: fmt(Number(e.pause||0)),
      workMin: Number(e.minutes||0),
      pauseMin: Number(e.pause||0),
    }));
  // PDF: always sort ascending by date (01..31)
  monthEntries.sort((a,b)=> String(a.date||'').localeCompare(String(b.date||'')));

  if(!monthEntries.length){
    showToast('‚ö†Ô∏è Keine Eintr√§ge in diesem Monat');
    return;
  }

  const projects = Array.from(new Set(monthEntries.map(e=>e.project).filter(Boolean)));
  const projectLabel = projects.length === 1 ? projects[0] : (projects.length ? 'Mehrere' : '-');

  const totalWorkMin = monthEntries.reduce((s,e)=>s+e.workMin,0);
  const totalPauseMin = monthEntries.reduce((s,e)=>s+e.pauseMin,0);

  // PDF export toggles
  const showSignature = LS('pdfSignature') !== false;
  const showPauseSum = LS('pdfPauseSum') !== false;
  const pdfCompact = LS('pdfCompact') === true;

  const doc = new jsPDF({ orientation:'p', unit:'mm', format:'a4' });

  doc.setFont('helvetica','bold');
  doc.setFontSize(18);
  doc.text('Arbeitszeitnachweis', 14, 18);

  doc.setFont('helvetica','normal');
  doc.setFontSize(11);
  doc.text(`Monat: ${monthName(Number(m)-1)} ${y}`, 14, 26);
  doc.text(`Projekt: ${projectLabel}`, 14, 32);

  doc.setDrawColor(180);
  doc.line(14, 36, 196, 36);

  const head = [['Datum', 'Projekt', 'Start', 'Stop', 'Arbeitszeit', 'Pause']];
  const body = monthEntries.map(e => [e.dateDisp, e.project, (e.startHM||'--:--'), (e.endHM||'--:--'), e.work, e.pause]);

  doc.autoTable({
    startY: 40,
    head,
    body,
    theme: 'grid',
    styles: { font: 'helvetica', fontSize: pdfCompact ? 9 : 10, cellPadding: pdfCompact ? 1.6 : 2.2 },
    headStyles: { fillColor: [30, 41, 59], textColor: [229, 231, 235] },
    margin: { left: 14, right: 14 },
  });

  const endY = doc.lastAutoTable.finalY || 40;

  doc.setFont('helvetica','bold');
  doc.setFontSize(11);
  doc.text(`Summe Arbeitszeit: ${fmt(totalWorkMin)}`, 14, endY + (pdfCompact ? 8 : 10));

  let yCursor = endY + (pdfCompact ? 13 : 16);
  if(showPauseSum){
    doc.text(`Summe Pause: ${fmt(totalPauseMin)}`, 14, yCursor);
    yCursor += 6;
  }

  if(showSignature){
    doc.setFont('helvetica','normal');
    doc.setFontSize(10);
    yCursor += (pdfCompact ? 5 : 8);
    doc.text('Unterschrift:', 14, yCursor);
    doc.setDrawColor(150);
    doc.line(40, yCursor, 196, yCursor);
  }

  doc.setFontSize(9);
  doc.setTextColor(100);
  const created = new Date().toLocaleString('de-AT');
  doc.text(`Erstellt am ${created}`, 14, 290);

  const file = `Arbeitszeit_${y}-${m}_${projectLabel.replace(/[^a-zA-Z0-9_-]/g,'_')}.pdf`;
  doc.save(file);

  showToast('üìÑ PDF erstellt');
  setStatus('üìÑ PDF Export fertig');
}

function updateInfo(){
  const all = LS('entries') || [];
  const now = new Date();
  const todayStr = now.toISOString().slice(0,10);

  // Soll-Einstellungen
  const dayTargetMin = parseTimeToMinutes(targetDay.value || '08:00');
  const workdaysPerWeek = Math.max(1, Math.min(7, Number(workdays.value || 5)));
  const weekTargetMin = dayTargetMin * workdaysPerWeek;

  // Heute
  const t = all.filter(e => e.date === todayStr);
  const workMin = t.reduce((s,e)=>s+Number(e.minutes||0),0);
  const pauseMin = t.reduce((s,e)=>s+Number(e.pause||0),0);
  workToday.textContent = fmt(workMin);
  pauseToday.textContent = fmt(pauseMin);

  // Woche (Mo‚Äìheute)
  const day = now.getDay() || 7; // Sonntag=7
  const monday = new Date(now);
  monday.setHours(0,0,0,0);
  monday.setDate(now.getDate() - day + 1);

  const weekMin = all
    .filter(e => {
      const d = new Date(String(e.date||'') + 'T00:00:00');
      return d >= monday && d <= now;
    })
    .reduce((s,e)=>s+Number(e.minutes||0),0);

  weekBalance.textContent = fmt(weekMin);

  // Monat (Monats-to-date: 1. bis heute)
  const y = now.getFullYear();
  const m = now.getMonth(); // 0-11
  const monthStart = new Date(y, m, 1);
  monthStart.setHours(0,0,0,0);

  const monthMin = all
    .filter(e => {
      const d = new Date(String(e.date||'') + 'T00:00:00');
      return d >= monthStart && d <= now;
    })
    .reduce((s,e)=>s+Number(e.minutes||0),0);

  // Ziel-Tage im Monat (Mo‚ÄìFr) von 1. bis heute
  let weekdayCount = 0;
  const iter = new Date(monthStart);
  while(iter <= now){
    const wd = iter.getDay(); // 0 So .. 6 Sa
    if(wd >= 1 && wd <= 5) weekdayCount++;
    iter.setDate(iter.getDate() + 1);
  }
  const monthTargetMin = dayTargetMin * weekdayCount;

  // √úberstunden
  otToday.textContent = fmtSigned(workMin - dayTargetMin);
  otWeek.textContent = fmtSigned(weekMin - weekTargetMin);
  otMonth.textContent = fmtSigned(monthMin - monthTargetMin);
}

// Restore running state
const run=LS('running');
if(run){
  startLiveTimer(run.start);
  setRunning(true);
  setStatus('‚è±Ô∏è Arbeitszeit l√§uft‚Ä¶');
} else {
  setRunning(false);
}

initMonthSelectors();
editDate.addEventListener('change', ()=>{ syncEditDatePretty(); });
editStart.addEventListener('change', ()=>{ syncEditTimeDisplays(); });
editEnd.addEventListener('change', ()=>{ syncEditTimeDisplays(); });

// Tap on visible fields opens native picker
if(typeof editDateDisplay !== 'undefined' && editDateDisplay){
  editDateDisplay.addEventListener('click', ()=> openNativePicker(editDate));
}
if(typeof editStartDisplay !== 'undefined' && editStartDisplay){
  editStartDisplay.addEventListener('click', ()=> openNativePicker(editStart));
}
if(typeof editEndDisplay !== 'undefined' && editEndDisplay){
  editEndDisplay.addEventListener('click', ()=> openNativePicker(editEnd));
}
updateInfo();
applyOvertimeVisibility();
try{ updateBackupStatusUI(); }catch(_){ }
// ensure display fields are in sync on load
try{ syncEditDatePretty(); syncEditTimeDisplays(); }catch(_){ }
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('./sw.js?v=5').catch(()=>{});
  });
}
</script>
<script>
/* ================= BACKUP SYSTEM ================= */

const BACKUP_KEY = 'backupHandle';
const AUTO_BACKUP_KEY = 'lastAutoBackup';

function fmtDateTimeDE(d){
  try{
    return new Date(d).toLocaleString('de-AT', {year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'});
  }catch(_){
    return String(d||'');
  }
}

function computeNextAutoBackupDate(){
  const enabled = LS('autoBackupEnabled') !== false;
  if(!enabled) return null;

  const now = new Date();
  const target = new Date();
  target.setHours(4,0,0,0);
  if(now >= target) target.setDate(target.getDate()+1);
  return target;
}

function updateBackupStatusUI(){
  const lastTextEl = document.getElementById('lastAutoBackupText');
  const nextTextEl = document.getElementById('nextAutoBackupText');
  if(!lastTextEl || !nextTextEl) return;

  const lastIso = LS('lastAutoBackupAt');
  lastTextEl.textContent = lastIso ? fmtDateTimeDE(lastIso) : '‚Äì';

  const next = computeNextAutoBackupDate();
  nextTextEl.textContent = next ? fmtDateTimeDE(next) : 'deaktiviert';
}

async function getBackupData(){
  return {
    meta:{
      app:'Time Tracker',
      version:'2.0',
      created:new Date().toISOString()
    },
    data:{
      entries: LS('entries') || [],
      settings:{
        project: LS('project'),
        pause: LS('pause'),
        targetDay: LS('targetDay'),
        workdays: LS('workdays'),
        showOvertime: LS('showOvertime'),
        pdfSignature: LS('pdfSignature'),
        pdfPauseSum: LS('pdfPauseSum'),
        pdfCompact: LS('pdfCompact')
      }
    }
  };
}

async function saveBackupFile(){
  const data = await getBackupData();
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const fileName = `time-tracker-backup_${new Date().toISOString().slice(0,10)}.json`;

  // Try File System Access API
  try{
    const handle = window._backupHandle || (await getStoredBackupHandle());
    if(handle){
      const writable = await handle.createWritable();
      await writable.write(blob);
      await writable.close();
      showToast('üíæ Backup gespeichert');
      return;
    }
  }catch(e){ console.warn('FS API failed, fallback to download', e); }

  // Fallback: normal download
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = fileName;
  a.click();
  URL.revokeObjectURL(a.href);
  showToast('üíæ Backup heruntergeladen');
}

async function chooseBackupLocation(){
  if(!window.showSaveFilePicker){
    showToast('‚ö†Ô∏è Browser unterst√ºtzt keinen festen Speicherort');
    return;
  }
  try{
    const handle = await window.showSaveFilePicker({
      suggestedName:'time-tracker-backup.json',
      types:[{description:'JSON', accept:{'application/json':['.json']}}]
    });
    window._backupHandle = handle;
    localStorage.setItem(BACKUP_KEY, JSON.stringify({}))
    showToast('üìÅ Speicherort gesetzt');
  }catch(e){ }
}

async function getStoredBackupHandle(){
  if(!window._backupHandle) return null;
  return window._backupHandle;
}

function runManualBackup(){
  saveBackupFile();
}

function importBackup(){
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json,application/json';
  input.onchange = async ()=>{
    const file = input.files[0];
    if(!file) return;
    try{
      const txt = await file.text();
      const json = JSON.parse(txt);
      if(!json || !json.data) throw new Error('Invalid');

      if(confirm('Backup importieren? Bestehende Daten werden √ºberschrieben.')){
        SS('entries', json.data.entries || []);
        const s = json.data.settings || {};
        Object.keys(s).forEach(k=> SS(k, s[k]));
        updateInfo();
        renderSelectedMonth();
        showToast('üì• Backup importiert');
      }
    }catch(e){
      showToast('‚ö†Ô∏è Ung√ºltiges Backup');
    }
  };
  input.click();
}

function shouldRunAutoBackup(){
  const enabled = LS('autoBackupEnabled') !== false;
  if(!enabled) return false;
  const running = LS('running');
  if(running) return false;
  const last = LS(AUTO_BACKUP_KEY);
  const today = new Date().toISOString().slice(0,10);
  return last !== today;
}

function scheduleAutoBackup(){
  const now = new Date();
  const target = new Date();
  target.setHours(4,0,0,0);
  if(now >= target) target.setDate(target.getDate()+1);

  const delay = target - now;
  setTimeout(async ()=>{
    if(shouldRunAutoBackup()){
      await saveBackupFile();
      SS(AUTO_BACKUP_KEY, new Date().toISOString().slice(0,10));
      SS('lastAutoBackupAt', new Date().toISOString());
    }
    // update status text if settings are open
    updateBackupStatusUI();
    scheduleAutoBackup();
  }, delay);
}

scheduleAutoBackup();
/* ================= END BACKUP SYSTEM ================= */
</script>
</body>
</html>